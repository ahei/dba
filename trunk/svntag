#!/bin/sh

# Time-stamp: <03/21/2009 19:19:38 Saturday by ahei>

readonly PROGRAM_NAME="svntag"
readonly PROGRAM_VERSION="1.0"

usage()
{
    cat << EOF
usage: ${PROGRAM_NAME} [OPTIONS]

This shell script can help you create or merge svn tag.

Options:
	-c	Create or merge svn current tag.
	-r	Create or merge svn release tag.
	-t <TRUNK_DIR>
		The directory of trunk, default is \`trunk'.
	-T <TAGS_DIR>
		The directory of tags, default is \`tags'.
	-i	Install this shell script to your machine.
	-n	Do not really execute command, only print command to execute.
	-R [<FILE>]
		Rollback to prev revision, <FILE> default is \`.'.
	-N <TAG_NAME>
		Set tag name manual.
	-v	Output version info.
	-h	Output this help.
EOF
    
    exit 1
}

version()
{
    echo "${PROGRAM_NAME} ${PROGRAM_VERSION}"
    exit 1
}

install()
{
    cp "$0" "${installDir}"
    ret=$?
    if [ "${ret}" = 0 ]; then
        echo "Install finished."
    fi
    exit "${ret}"
}

executeCommand()
{
    command="$1"
    isExecute="$2"

    echo "Executing command \`${command}' ..."
    if [ "${isExecute}" != "0" ]; then
        eval "${command}"
        if [ $? != 0 ]; then
            echo "Execute command \`${command}' failed"
            exit 1
        fi
    fi
}

getRevisionNo()
{
    dir="$1"
    LANG= svn info "${dir}" -r HEAD 2>/dev/null | grep "Revision: " | sed -r "s/^Revision: ([[:digit:]]+)$/\1/g"
}

rollback()
{
    dir="$1"
    isExecute="$2"
    
    executeCommand "svn up ${dir}" "${isExecute}"
    executeCommand "svn merge -r HEAD:PREV ${dir}" "${isExecute}"
    exit $?
}

installDir="/usr/bin"
trunkDir="trunk"
tagsDir="tags"
isExecute=1

while getopts :hvcrit:T:nR:N: OPT; do
    case "$OPT" in
        c)
            tagName="current"
            ;;
            
        r)
            tagName="release"
            ;;

        i)
            install
            ;;
            
        t)
            trunkDir="${OPTARG}"
            ;;

        T)
            tagsDir="${OPTARG}"
            ;;

        n)
            isExecute=0
            ;;

        R)
            rollbackFile="${OPTARG}"
            ;;

        N)
            tagName="${OPTARG}"
            ;;
            
        v)
            version
            ;;

        h)
            usage
            ;;

        :)
        case "${OPTARG}" in
            R)
                rollbackFile="."
                ;;

            ?)
                echo "Option \`-${OPTARG}' need argument.\n"
                usage
        esac
        ;;

        ?)
            echo "Invalid option \`-${OPTARG}'.\n"
            usage
            ;;
    esac
done

[ -n "${rollbackFile}" ] && rollback "${rollbackFile}" "${isExecute}"

if [ -z "${tagName}" ]; then
    usage
fi

if [ -f "${tagsDir}/${tagName}" ]; then
    echo "File ${tagsDir}/${tagName} is exists, can not create tag \`${tagName}'."
    exit 1
fi

dateTimeRegexp="[[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2} [[:digit:]]{2}:[[:digit:]]{2}:[[:digit:]]{2}"

# merge tag
if [ -d "${tagsDir}/${tagName}" ]; then
    fromRevisionNo=`svn log "${tagsDir}/${tagName}" -r COMMITTED | sed -n 4p | sed -r "s/^Create tag ${tagName} from trunk r([[:digit:]]+)\.$/\1/g" | grep -x -E "[[:digit:]]+"`
    if [ -z "${fromRevisionNo}" ]; then
        fromRevisionNo=`svn log "${tagsDir}/${tagName}" -r COMMITTED | sed -n 4p | sed -r "s/^Merge trunk r[[:digit:]]+:([[:digit:]]+) to tag ${tagName}\.$/\1/g" | grep -x -E "[[:digit:]]+"`
    fi
    if [ -z "${fromRevisionNo}" ]; then
        echo "Get from revision number of ${tagsDir}/${tagName} failed."
        exit 1
    fi

    executeCommand "svn up ${trunkDir}" "${isExecute}"
    executeCommand "svn up ${tagsDir}/${tagName}" "${isExecute}"

    if [ "${tagName}" = "release" ]; then
        dateTime=`svn log "${tagsDir}/${tagName}" -r COMMITTED | sed -n 2p | sed -r "s/^r[[:digit:]]+ \| .+ \| (${dateTimeRegexp}).* \| .*$/\1/g" | grep -x -E "${dateTimeRegexp}" | sed "s/ /-/g"`
        if [ -z "${dateTime}" ]; then
            echo "Get date time of tag ${tagName} failed."
            exit 1
        fi
            
        executeCommand "svn cp ${tagsDir}/${tagName} ${tagsDir}/${tagName}_${dateTime}" "${isExecute}"
    fi

    toRevisionNo=`getRevisionNo "${trunkDir}"`
    executeCommand "svn merge ${trunkDir} -r${fromRevisionNo}:${toRevisionNo} ${tagsDir}/${tagName}" "${isExecute}"
    executeCommand "svn ci -m \"Merge trunk r${fromRevisionNo}:${toRevisionNo} to tag ${tagName}.\"" "${isExecute}"
    
    exit
fi

# create tag
revisionNo=`getRevisionNo "${trunkDir}"`
if [ -z "${revisionNo}" ]; then
    echo "Get revision number of ${trunkDir} failed."
    exit 1
fi

executeCommand "svn up ${trunkDir}" "${isExecute}"
executeCommand "svn up ${tagsDir}/${tagName}" "${isExecute}"
executeCommand "svn cp ${trunkDir} ${tagsDir}/${tagName}" "${isExecute}"
executeCommand "svn ci -m \"Create tag ${tagName} from trunk r${revisionNo}.\"" "${isExecute}"
